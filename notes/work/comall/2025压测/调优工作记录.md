## 1. 配置优化

### hystrix调优

**目的: 默认所有 Feign 方法可能会用同一个 Hystrix 线程池，池子满了会导致失败率飙升。给高频接口单独线程池以及hystrix配置 **

--- 

### dc-order 

``` yaml 
hystrix: 
  command:
    default:
      execution:
        timeout:
          enabled: true
        isolation:
          thread:
            timeoutInMilliseconds: 60000
    StockClient#occupyShopStocks:
      execution:
        timeout:
          enabled: true
        isolation:
          thread:
            timeoutInMilliseconds: 60000
      circuitBreaker:
        requestVolumeThreshold: 160    # 10秒内至少160次请求才可能触发熔断
        errorThresholdPercentage: 70   # 失败率≥40%时触发熔断
        sleepWindowInMilliseconds: 10000   # 熔断后10秒尝试半开状态
    GoodsClient#getSkuInfo(String):
      execution:
        timeout:
          enabled: true
        isolation:
          thread:
            timeoutInMilliseconds: 60000
      circuitBreaker:
        requestVolumeThreshold: 160        # 至少160次才统计
        errorThresholdPercentage: 80      # 失败率≥80%才熔断
        sleepWindowInMilliseconds: 10000   # 熔断后10秒尝试半开状态
    GoodsClient#getSkus(SkuIntegrationParams):
      execution:
        timeout:
          enabled: true
        isolation:
          thread:
            timeoutInMilliseconds: 60000
      circuitBreaker:
        requestVolumeThreshold: 160
        errorThresholdPercentage: 80
        sleepWindowInMilliseconds: 10000
    GoodsClient#getIntegrationGoodsInfo(String):
      execution:
        timeout:
          enabled: true
        isolation:
          thread:
            timeoutInMilliseconds: 60000
      circuitBreaker:
        requestVolumeThreshold: 160
        errorThresholdPercentage: 80
        sleepWindowInMilliseconds: 10000

  threadpool:
    default:
      coreSize: 200 #并发执行的最大线程数，默认10
      maxQueueSize: 1000 #BlockingQueue的最大队列数，默认值-1
      queueSizeRejectionThreshold: 800 #即使maxQueueSize没有达到，达到queueSizeRejectionThreshold该值后，请求也会被拒绝，默认值5  
    GoodsClient#getSkus(SkuIntegrationParams): #单独分配线程池
      coreSize: 200
      maxQueueSize: 1000
      queueSizeRejectionThreshold: 800
    GoodsClient#getSkuInfo(String):
      coreSize: 200
      maxQueueSize: 1000
      queueSizeRejectionThreshold: 800
    GoodsClient#getIntegrationGoodsInfo(String):
      coreSize: 200
      maxQueueSize: 1000
      queueSizeRejectionThreshold: 800
    StockClient#occupyShopStocks:
      coreSize: 200
      maxQueueSize: 1000
      queueSizeRejectionThreshold: 800
```

---
### dc-ali-goods
``` yaml
hystrix:
  command:
    default:
      execution:
        timeout:
          enabled: true
        isolation:
          thread:
            timeoutInMilliseconds: 60000
    GoodsClient#getSkus(SkuIntegrationParams):
      execution:
        timeout:
          enabled: true
        isolation:
          thread:
            timeoutInMilliseconds: 60000
      circuitBreaker:
        requestVolumeThreshold: 160
        errorThresholdPercentage: 80
        sleepWindowInMilliseconds: 10000
  threadpool:
    default:
      coreSize: 200 #并发执行的最大线程数，默认10
      maxQueueSize: 1000 #BlockingQueue的最大队列数，默认值-1
      queueSizeRejectionThreshold: 800 #即使maxQueueSize没有达到，达到queueSizeRejectionThreshold该值后，请求也会被拒绝，默认值5
    AliGoodsClient.getXcodeByOuterSkuId():
      coreSize: 200
      maxQueueSize: 1000
      queueSizeRejectionThreshold: 800
```

--- 
### dc-goods
- 以下配置为了避免 **uriSessionMapFullCount is full错误** 
``` yaml
# 德鲁伊配置,监控排除/integration:
      web-stat-filter:
        enabled: true
        exclusions: '*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*,/integration/*'
``` 

## 2. 代码优化
### dc-order
- Branch：qa-pet-2025
- commit：==10d2e4d688a878fdb5f01751d1e7ecd3c43c56e6==
- messgae：t-[500]-[QA-PET-2025]-[StockClient新增fallback]-[汤浩]

--- 
### dc-promotion
- Branch：qa-pet-2025
- commit：
    ==5731820112e92184195e9f284dd1d3e8ea8a1c14 b5b925792f7f8be37f0ea149b5910a5268d5074d dffd92640dd0eb5f4674c5ac51841caaa7b0c042 b82c420050b6741b8b4ab1167d82b18e63a96e59 7077d0bcc5faa63844cf3460fd8ada6fff94c8de 8908674c29508facc34c3418b5cf11ff4849f535 073a10f22aa6d9d983a0030b6120c8167dfb58bd 480d418f4caf8beaedc00b406e02f75729557126==
- message：t-[500]-[qa-pet-2025]-[缓存优化]-[汤浩]

## 3. 数据库表索引
``` sql
create index dc_promotion_activity_shop_code_index
    on ctf_promotion.dc_promotion_activity (shop_code);


create index dc_goods_sku_bind_sku_sku_code_index
    on ctf_goods.dc_goods_sku_bind_sku (sku_code);


create index dc_ali_stock_sync_log_tmall_sku_id_index
    on ctf_ali_goods.dc_ali_stock_sync_log (tmall_sku_id);

create index dc_goods_material_stock_type_spu_code_index
    on ctf_goods.dc_goods_material (stock_type, spu_code);

create index dc_giveaway_master_code_index
    on ctf_giveaway.dc_giveaway_master (code);



ALTER TABLE `ctf_promotion`.`dc_promotion_discount_detail` 
ADD INDEX `STOCK_TYPE_DISCOUNT_CODE_IDX` (`discount_code` ASC, `stock_type` ASC);

ALTER TABLE `ctf_goods`.`dc_goods_material` 
ADD INDEX `SPU_CODE_IDX` (`spu_code` ASC);

  
create index adpt_order_exception_order_id_exception_type_index  
    on adpt_order.adpt_order_exception (order_id, exception_type);
    
create index dc_raw_refund_outer_order_id_index
    on ctf_refund.dc_raw_refund (outer_order_id);
    
create index dc_goods_sku_code_index
    on ctf_goods.dc_goods_sku (code);
    
create index dc_jd_goods_sku_mapping_outer_id_index
    on ctf_jd_goods.dc_jd_goods_sku_mapping (outer_id);
    
create index dc_jd_stock_sync_log_jd_sku_id_index
    on ctf_jd_goods.dc_jd_stock_sync_log (jd_sku_id);

create index dc_jd_goods_sku_mapping_sku_code_outer_id_index
    on ctf_jd_goods.dc_jd_goods_sku_mapping (sku_code, outer_id);
    
create index dc_jd_goods_sku_mapping_shop_code_sku_code_index
    on ctf_jd_goods.dc_jd_goods_sku_mapping (shop_code, sku_code);
``` 
