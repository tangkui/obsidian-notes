# FS-1382
# FS-1377

## ctf_order  
- [x] 已上传脚本仓库
```sql 
alter table ctf_order.dc_order_item add column  activity_rule_id bigint default null comment '营销活动规则id';

alter table ctf_order.dc_order_item_expand add column stock_deduct_result  tinyint(1)   default 0 comment '赠品库存是否扣减成功(只针对赠品库存的扣减结果)';

  
INSERT INTO ctf_order.dc_exception (id, exception_type_name, exception_type, exception_info, exception_status,  
                                    create_time, update_time)  
VALUES (20251017144235, '平台赠品未匹配到活动', 'PLATFORM_GIFT_ACTIVITY_NOT_FOUND', '平台赠品未匹配到活动', 1, now(),  
        now());  
  
  
INSERT INTO ctf_order.dc_exception (id, exception_type_name, exception_type, exception_info, exception_status,  
                                    create_time, update_time)  
VALUES (20251017144405, '赠品可售数不足', 'GIFT_SALE_QUANTITY_NOT_ENOUGH', '赠品可售数不足', 1, now(), now());

  
ALTER TABLE CTF_ORDER.DC_ORDER_EXCEPTION  
    ADD INDEX IDX_EXCEPTION_ID (EXCEPTION_ID);  
  
ALTER TABLE CTF_ORDER.DC_ORDER_EXCEPTION  
    ADD INDEX UK_ORDER_ID_EXCEPTION_ID (ORDER_ID, EXCEPTION_ID);
``` 
# FS-1379

## ctf_refund
- [x] 已上传脚本仓库
``` sql
alter table ctf_refund.dc_refund_item add column  activity_rule_id bigint default null comment '营销活动规则id';

  
alter table ctf_refund.dc_inbound_order_item add column gifts_type  varchar(64) collate utf8mb4_bin   null comment '是否赠品 【GOODS:非赠品  ORDINARY_GIFTS:普通赠品   GOODS_CONVERTED_GIFTS:货转赠】';  
```
## ctf_b2b_order
- [x] 已上传脚本仓库
```sql 

create table ctf_b2b_order.dc_b2b_order_sale_goods_detail  
(  
    id               bigint               not null comment '主键ID'  
        primary key,  
    sale_goods_id    bigint               null comment '销售单商品项ID',  
    material_code    varchar(255)         null comment '物料编码',  
    material_type    varchar(32)          null comment '物料类型',  
    quantity         int(10)              null comment '数量',  
    bar_code         varchar(255)         null comment '条码',  
    name             varchar(500)         null comment '物料名称',  
    create_time      datetime             null comment '创建时间',  
    last_modify_time datetime             null comment '最后修改时间',  
    sale_id          bigint               null comment '移库销售单id',  
    is_channel_gift  tinyint(1) default 0 null comment '是否渠道赠品',
    channel_sku_code varchar(255)         null comment '渠道sku编码'  
);

create index dc_b2b_order_sale_goods_detail_material_code_index  
    on ctf_b2b_order.dc_b2b_order_sale_goods_detail (material_code);  
  
create index dc_b2b_order_sale_goods_detail_sale_goods_id_index  
    on ctf_b2b_order.dc_b2b_order_sale_goods_detail (sale_goods_id);  
  
create index dc_b2b_order_sale_goods_detail_sale_id_index  
    on ctf_b2b_order.dc_b2b_order_sale_goods_detail (sale_id);
    

alter table ctf_b2b_order.dc_b2b_order_goods add column  activity_rule_id bigint default null comment '营销活动规则id';  

alter table ctf_b2b_order.dc_b2b_order_goods add column  available_qty int(10) default 0 comment '赠品可售数';  
  
alter table ctf_b2b_order.dc_b2b_order_goods add column stock_deduct_result  tinyint(1)   default 0 comment '赠品库存是否扣减成功(只针对赠品物料库存的扣减结果)';

```

## ctf_sf_adaptor
- [x] 已上传脚本仓库
``` sql
create table ctf_sf_adaptor.dc_odo_sf_item_detail(  
    id                       bigint            not null comment '主键ID'  
        primary key,  
    odo_sf_id        bigint       not null comment 'odoSf主键id',  
    item_id                  bigint            null comment '商品项ID',  
    material_code  varchar(255) null comment '物料编码',  
    material_type varchar(32) null comment '物料类型',  
    quantity int(10) null comment '数量',  
    bar_code varchar(255) null comment '条码',  
    name varchar(500) null comment  '物料名称',  
    create_time              datetime          null comment '创建时间',  
    last_modify_time              datetime          null comment '最后修改时间'  
);

create index dc_odo_sf_item_detail_item_id_index  
    on ctf_sf_adaptor.dc_odo_sf_item_detail (item_id);  
  
create index dc_odo_sf_item_detail_material_code_index  
    on ctf_sf_adaptor.dc_odo_sf_item_detail (material_code);  
  
create index dc_odo_sf_item_detail_odo_sf_id_index  
    on ctf_sf_adaptor.dc_odo_sf_item_detail (odo_sf_id);
```

## ctf_bulk_file
``` sql
update ctf_bulk_file.dc_bulk_file_field set dc_bulk_file_field.pattern = '{"商品":"GOODS", "货转赠":"GIFT_SKU", "物料赠品":"MATERIEL","普通赠品":"ORDINARY_GIFTS"}' where id = '572';

update ctf_bulk_file.dc_bulk_file_template set file_id = '8634089570340552704' where id = '72';
```


## 销售报表
### 2B京东自营销售单
``` sql
  
SELECT CASE  
           WHEN d.material_type IN ('GIVEAWAY', 'MATERIAL') THEN d.material_code  
           ELSE NULL  
           END                               AS 物料编码,  
       CASE           WHEN d.material_type IN ('GIVEAWAY', 'MATERIAL') THEN d.name  
           ELSE NULL  
           END                               AS 物料名称,  
  
       d.quantity                            AS 赠品数量,  
  
       CASE           WHEN d.material_type IN ('GIVEAWAY', 'MATERIAL') THEN d.bar_code  
           ELSE g.sku_code
           END                               AS X码,  
  
       CASE           WHEN d.material_type IN ('GIVEAWAY', 'MATERIAL') THEN d.bar_code  
           ELSE sku.spu_code  
           END                               AS 模号,  
  
       CASE           WHEN d.material_type = 'GIVEAWAY' THEN '赠品'  
           WHEN d.material_type = 'MATERIAL' THEN '物料'  
           ELSE '货品'  
           END                               AS 赠品类型,  
  
       CONCAT(o.shop_code, '-', o.shop_name) AS 销售店铺,  
       o.sale_code                           AS `订单号(京东自营销售单号)`,  
       o.order_create_time                   AS 下单时间  
  
FROM ctf_b2b_order.dc_b2b_order_sale_goods_detail d  
         LEFT JOIN ctf_b2b_order.dc_b2b_order_sale o  
                   ON o.id = d.sale_id  
         LEFT JOIN ctf_b2b_order.dc_b2b_order_sale_goods g  
                   ON g.id = d.sale_goods_id  
         LEFT JOIN ctf_goods.dc_goods_sku sku  
                   ON sku.code = g.sku_code  
  
WHERE o.sale_type = 'NORMAL';
``` 
### 2C出库单
```sql 
  
SELECT O.OUTER_OUTBOUND_ORDER_ID                                      AS 出库单号,  
       CASE           WHEN O.ORDER_TYPE = 'B2B' THEN '移库出库单'  
           ELSE 'B2C出库单'  
           END                                                        AS 出库类型,  
       T.GOODS_NAME                                                   AS '出库商品/赠品/物料',  
       CASE           WHEN T.GIFTS_TYPE IN ('ORDINARY_GIFTS', 'MATERIAL') THEN T.XCODE  
           ELSE NULL  
           END                                                        AS 物料编码,  
       CASE           WHEN T.GIFTS_TYPE IN ('ORDINARY_GIFTS', 'MATERIAL') THEN T.GOODS_NAME  
           ELSE NULL  
           END                                                        AS 物料名称,  
       CASE           WHEN T.GIFTS_TYPE IN ('ORDINARY_GIFTS', 'MATERIAL') THEN T.QUANTITY  
           ELSE NULL  
           END                                                        AS 赠品数量,  
       T.MODULE_NUMBER                                                AS 模号,  
       T.XCODE                                                        AS X码,  
       CASE           WHEN T.GIFTS_TYPE = 'ORDINARY_GIFTS' THEN '赠品'  
           WHEN T.GIFTS_TYPE = 'GOODS_CONVERTED_GIFTS' THEN '货转赠'  
           WHEN T.GIFTS_TYPE = 'MATERIAL' THEN '物料'  
           WHEN T.GIFTS_TYPE = 'GOODS' THEN '货品'  
           ELSE '未知类型'  
           END                                                        AS 赠品类型,  
       CASE           WHEN O.CHANNEL_ID = '1000' THEN '天猫'  
           WHEN O.CHANNEL_ID = '1001' THEN '京东'  
           WHEN O.CHANNEL_ID = '1002' THEN '淘宝'  
           WHEN O.CHANNEL_ID = '1003' THEN '唯品会'  
           WHEN O.CHANNEL_ID = '1004' THEN '苏宁'  
           WHEN O.CHANNEL_ID = '1005' THEN '网易考拉'  
           WHEN O.CHANNEL_ID = '1006' THEN '小红书'  
           WHEN O.CHANNEL_ID = '1007' THEN '抖音'  
           WHEN O.CHANNEL_ID = '1008' THEN '拼多多'  
           WHEN O.CHANNEL_ID = '1014' THEN '得物'  
           WHEN O.CHANNEL_ID = '1015' THEN '周大福官方商城'  
           WHEN O.CHANNEL_ID = '1016' THEN '快手'  
           WHEN O.CHANNEL_ID = '0' THEN '磐石'  
           WHEN O.CHANNEL_ID = '2001' THEN '导单渠道'  
           WHEN O.CHANNEL_ID = '3001' THEN '磐石大客户定制'  
           ELSE '未知渠道'  
           END                                                        AS 平台,  
       CONCAT(O.SHOP_ID, '-', O.SHOP_NAME)                            AS 销售店铺,  
       O.OUTER_ORDER_ID                                               AS 2C订单号,  
       CASE           WHEN R.ORDER_STATUS = 'WAIT_PAY' THEN '待付款'  
           WHEN R.ORDER_STATUS = 'PAID' THEN '已付款'  
           WHEN R.ORDER_STATUS = 'REVIEWED' THEN '已过审'  
           WHEN R.ORDER_STATUS = 'DELIVERED' THEN '已发货'  
           WHEN R.ORDER_STATUS = 'SIGNED' THEN '已签收'  
           WHEN R.ORDER_STATUS = 'CANCELED' THEN '已取消'  
           WHEN R.ORDER_STATUS = 'WAIT_AUDIT' THEN '待审核'  
           WHEN R.ORDER_STATUS = 'WAIT_SEND' THEN '待发货'  
           WHEN R.ORDER_STATUS = 'ASSOCIATED' THEN '已关联'  
           WHEN R.ORDER_STATUS = 'COMPLETED' THEN '完成'  
           ELSE '未知状态'  
           END                                                        AS 2C订单状态,  
       R.PAY_TIME                                                     AS 2C付款时间,  
       A.CODE                                                         AS 活动编码,  
       A.NAME                                                         AS 活动名称,  
       CASE WHEN A.STATUS = 'ENABLE' THEN '进行中' ELSE '已结束' END  AS 活动状态,  
       A.START_TIME                                                   AS 活动开始时间,  
       A.END_TIME                                                     AS 活动结束时间,  
       A.SHOP_CODE                                                       '活动参与店铺(当前活动全量店铺)',  
       AR.NAME                                                        AS 活动规则名称,  
       CASE WHEN AR.STATUS = 'ENABLE' THEN '进行中' ELSE '已结束' END AS 活动规则状态,  
       RG.PER_NUM                                                     AS 活动规则赠送数量,  
       CASE           WHEN AR.TYPE = 'BUY_GIFTS_REQUIRED' THEN '买赠规则（必购）'  
           WHEN AR.TYPE = 'BUY_GIFTS_OPTIONAL' THEN '买赠规则（选购）'  
           WHEN AR.TYPE = 'FULL_GIFTS_REQUIRED' THEN '满赠规则（必购）'  
           WHEN AR.TYPE = 'FULL_GIFTS_OPTIONAL' THEN '满赠规则（选购）'  
           WHEN AR.TYPE = 'EACH_TO_BUY_GIFTS_REQUIRED' THEN '每买赠（必购）'  
           WHEN AR.TYPE = 'EACH_TO_BUY_GIFTS_OPTIONAL' THEN '每买赠（选购）'  
           WHEN AR.TYPE = 'PRE_SALE' THEN '预售'  
           WHEN AR.TYPE = 'PLATFORM' THEN '平台赠'  
           ELSE '未知类型'  
           END                                                        AS 规则类型,  
       CONCAT(AR.START_TIME, '-', AR.END_TIME)                        AS 规则有效期  
FROM CTF_SEARCH_SOURCING.DC_OUTBOUND_ORDER_ITEM T  
         LEFT JOIN CTF_SEARCH_SOURCING.DC_OUTBOUND_ORDER O ON O.ID = T.OUTBOUND_ORDER_ID  
         LEFT JOIN CTF_ORDER.DC_ORDER R ON R.ID = T.ORDER_ID  
         LEFT JOIN CTF_PROMOTION.DC_PROMOTION_ACTIVITY A ON A.CODE = T.ACTIVITY_CODE  
         LEFT JOIN CTF_PROMOTION.DC_PROMOTION_ACTIVITY_RULE AR ON AR.ID = T.ACTIVITY_RULE_ID  
         LEFT JOIN CTF_PROMOTION.DC_PROMOTION_ACTIVITY_RULE_GIVEAWAY RG ON RG.ACTIVITY_RULE_ID = T.ACTIVITY_RULE_ID  
WHERE O.ORDER_TYPE != 'B2B';
``` 

